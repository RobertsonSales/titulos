<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Faturas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* [Todo o CSS existente permanece exatamente igual] */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  padding: 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  min-height: 100vh;
  font-size: 16px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

.header {
  text-align: center;
  padding: 30px;
  background: linear-gradient(135deg, #f093fb, #f5576c);
  color: #fff;
}

.header h1 {
  font-size: 2em;
  margin-bottom: 8px;
}

.header p {
  font-size: 1.1em;
}

.sec {
  padding: 20px 25px;
  border-bottom: 1px solid #eee;
}

input[type="text"],
input[type="file"],
input[type="date"] {
  width: 100%;
  padding: 14px 16px;
  border: 3px solid #ddd;
  border-radius: 10px;
  font-size: 16px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

input[type="text"]:focus,
input[type="date"]:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
  transform: translateY(-2px);
}

input[type="text"]::placeholder {
  color: #999;
  font-weight: 500;
}

.search-highlight {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 15px;
}

.search-highlight input[type="text"] {
  background: white;
  border: 3px solid #fff;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  font-size: 17px;
  font-weight: 500;
}

.search-highlight input[type="text"]:focus {
  border-color: #f5576c;
  box-shadow: 0 4px 20px rgba(245, 87, 108, 0.3);
}

.btns {
  text-align: center;
  margin-top: 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

button {
  padding: 12px 20px;
  margin: 0;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

button:active {
  transform: translateY(0);
}

.btn-p {
  background: #3498db;
}

.btn-s {
  background: #95a5a6;
}

.btn-g {
  background: #27ae60;
}

.btn-r {
  background: #e74c3c;
}

.btn-v {
  background: #8e44ad;
}

.btn-pdf {
  background: #ee5a24;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  padding: 15px;
}

.filters label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 500;
  padding: 8px 12px;
  border-radius: 8px;
  transition: background 0.2s;
}

.filters label:hover {
  background: #f0f0f0;
}

.filters input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.date-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  align-items: flex-end;
}

.date-row > div {
  flex: 1;
  min-width: 160px;
}

.date-row small {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #555;
  font-size: 14px;
}

.date-row input {
  width: 100%;
}

.res-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 18px;
  border-radius: 10px;
  text-align: center;
  margin-bottom: 15px;
  font-size: 18px;
}

.summary {
  background: linear-gradient(135deg, #11998e, #38ef7d);
  color: #fff;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin-bottom: 20px;
  font-size: 17px;
  line-height: 1.8;
}

.summary b {
  font-size: 19px;
  display: block;
  margin-bottom: 12px;
}

.summary-line {
  display: inline-block;
  margin: 0 15px;
  font-size: 16px;
  font-weight: 600;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 15px;
}

.card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.card-h {
  padding: 15px;
  color: #fff;
  font-weight: 600;
  font-size: 16px;
}

.card-h small {
  font-size: 14px;
  opacity: 0.95;
}

.card-b {
  padding: 15px;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

th,
td {
  padding: 8px 6px;
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 13px;
}

th {
  background: #f5f5f5;
  font-weight: 600;
  font-size: 13px;
}

.totals {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: space-between;
  margin-top: 10px;
}

.t-box {
  flex: 1;
  min-width: 110px;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  color: #fff;
  font-weight: 600;
  font-size: 13px;
}

.t-ov {
  background: #e74c3c;
}

.t-fut {
  background: #f39c12;
}

.t-paid {
  background: #27ae60;
}

.t-gen {
  background: #3498db;
}

.cbs {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  margin-top: 12px;
  padding: 15px;
  background: #f9f9f9;
  border-radius: 8px;
}

.cbs label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-size: 15px;
  padding: 10px 12px;
  background: white;
  border-radius: 6px;
  border: 2px solid #e0e0e0;
  transition: all 0.2s;
}

.cbs label:hover {
  border-color: #3498db;
  background: #f0f8ff;
}

.cbs input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.sec > b {
  font-size: 17px;
  color: #333;
}

.no-res {
  text-align: center;
  padding: 40px;
  color: #999;
  font-size: 16px;
}

.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.load-box {
  background: white;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  min-width: 300px;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

#loadTxt {
  font-size: 16px;
  margin-bottom: 15px;
  color: #333;
}

.prog-bar {
  width: 100%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
}

.prog-fill {
  height: 100%;
  background: linear-gradient(90deg, #3498db, #2ecc71);
  transition: width 0.3s;
}

.toast {
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #27ae60;
  color: white;
  padding: 15px 25px;
  border-radius: 8px;
  font-size: 15px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  z-index: 10000;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal-c {
  background: white;
  border-radius: 15px;
  max-width: 1000px;
  max-height: 90vh;
  overflow-y: auto;
  width: 100%;
}

.modal-h {
  background: linear-gradient(135deg, #f093fb, #f5576c);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 18px;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 32px;
  cursor: pointer;
  padding: 0;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.tbl-wrap {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-top: 10px;
}

.u-tbl {
  font-size: 14px;
}

.u-tbl th {
  position: sticky;
  top: 0;
  background: #3498db;
  color: white;
  z-index: 10;
  font-size: 14px;
}

.u-tbl td {
  font-size: 13px;
}

.sum-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.sum-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #3498db;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  font-size: 14px;
  line-height: 1.6;
}

.sum-card b {
  display: block;
  margin-bottom: 8px;
  color: #3498db;
  font-size: 15px;
}

.pdf-prev {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2000;
  overflow-y: auto;
  padding: 20px;
}

.prev-pages {
  max-width: 800px;
  margin: 0 auto 20px;
}

.prev-page {
  background: white;
  margin-bottom: 20px;
  padding: 10px;
  border-radius: 8px;
}

.prev-page img {
  width: 100%;
  display: block;
  border-radius: 4px;
}

.pg-lbl {
  text-align: center;
  padding: 10px;
  font-weight: 600;
  color: #333;
}

.prev-ctrl {
  position: sticky;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  max-width: 800px;
  margin: 0 auto;
}

small {
  font-size: 14px;
}

/* Estilos adicionais para o resumo por empresa */
.company-summary {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
  border-left: 4px solid #3498db;
}

.company-summary h4 {
  margin-bottom: 8px;
  color: #2c3e50;
  font-size: 15px;
}

.company-summary table {
  width: 100%;
  font-size: 13px;
  margin-bottom: 0;
}

.company-summary th {
  background: #e9ecef;
  font-weight: 600;
  padding: 6px 4px;
}

.company-summary td {
  padding: 6px 4px;
}
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="load-box">
    <div class="spinner"></div>
    <div id="loadTxt">Gerando PDF...</div>
    <div class="prog-bar">
      <div class="prog-fill" id="progBar" style="width:0"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Conclu√≠do!</div>

<div class="container">
  <div class="header">
    <h1>Consulta de T√≠tulos</h1>
    <p>Quitados ou em aberto</p>
  </div>

  <div class="sec">
    <input type="file" id="fileIn" accept=".xlsx,.xls">
    <small>Arquivo: <span id="fName">-</span> | Registros: <span id="rLoaded">0</span></small>
  </div>

  <div class="sec">
    <div class="search-highlight">
      <input type="text" id="searchIn" placeholder="üîç Buscar cliente...">
      <input type="text" id="vendorIn" placeholder="üîç Buscar vendedor...">
    </div>
    <div class="btns">
      <button class="btn-s" id="clearBtn">Limpar Tudo</button>
      <button class="btn-v" id="allCliBtn">Todos Clientes</button>
      <button class="btn-v" id="allVendBtn">Todos Vendedores</button>
      <button class="btn-r" id="unpaidBtn">Inadimpl√™ncia Per√≠odo</button>
      <button class="btn-r" id="compUnpaidBtn">Inadimpl√™ncia Empresa</button>
    </div>
  </div>

  <div class="sec" id="cliCbs" style="display:none">
    <b>Clientes:</b>
    <div class="cbs" id="cliList"></div>
  </div>

  <div class="sec" id="vendCbs" style="display:none">
    <b>Vendedores:</b>
    <div class="cbs" id="vendList"></div>
  </div>

  <div class="sec" id="dateF" style="display:none">
    <div class="date-row">
      <div>
        <small>Data In√≠cio:</small>
        <input type="date" id="startD">
      </div>
      <div>
        <small>Data Fim:</small>
        <input type="date" id="endD">
      </div>
      <button class="btn-p" id="applyD">Aplicar</button>
      <button class="btn-s" id="clearD">Limpar Datas</button>
    </div>
  </div>

  <div class="sec filters">
    <label>
      <input type="checkbox" id="chkOv" checked> Vencidos
    </label>
    <label>
      <input type="checkbox" id="chkFut"> A Vencer
    </label>
    <label>
      <input type="checkbox" id="chkPaid"> Quitados
    </label>
  </div>

  <div class="sec">
    <div class="res-header">
      <b>Clientes Encontrados: <span id="cFound">0</span></b>
    </div>
    <div class="summary" id="summary" style="display:none">
      <b>Resumo Geral</b>
      <div class="summary-line">Vencidos: <span id="tOv">R$ 0,00</span></div>
      <div class="summary-line">A Vencer: <span id="tFut">R$ 0,00</span></div>
      <div class="summary-line">Quitados: <span id="tPaid">R$ 0,00</span></div>
      <div class="summary-line">Total: <span id="tGen">R$ 0,00</span></div>
    </div>
    <div id="results">
      <div class="no-res">Nenhum resultado</div>
    </div>
  </div>

  <div class="sec btns">
    <button class="btn-pdf" id="pdfBtn">Gerar PDF</button>
    <button class="btn-g" id="xlsxBtn">Exportar XLSX</button>
  </div>

  <div class="pdf-prev" id="pdfPrev">
    <div class="prev-pages" id="prevPages"></div>
    <div class="prev-ctrl">
      <button class="btn-p" id="dlPdf">Download PDF</button>
      <button class="btn-s" id="closePdf">Fechar</button>
    </div>
  </div>
</div>

<div class="modal" id="unpaidM">
  <div class="modal-c">
    <div class="modal-h">
      <b>Faturas N√£o Liquidadas</b>
      <button class="close-btn" onclick="closeModal('unpaidM')">&times;</button>
    </div>
    <div class="sec">
      <div class="date-row">
        <div>
          <small>Data In√≠cio:</small>
          <input type="date" id="uStart">
        </div>
        <div>
          <small>Data Fim:</small>
          <input type="date" id="uEnd">
        </div>
        <button class="btn-p" id="applyU">Aplicar</button>
        <button class="btn-s" id="clearU">Limpar</button>
      </div>
    </div>
    <div id="uSum" style="display:none">
      <b>Resumo por Empresa</b>
      <div class="sum-cards" id="uSumCards"></div>
    </div>
    <div id="uRes">
      <div class="no-res">Selecione o per√≠odo</div>
    </div>
    <div class="btns">
      <button class="btn-pdf" id="uPdfBtn">Gerar PDF</button>
      <button class="btn-g" id="uXlsxBtn">Exportar XLSX</button>
    </div>
    <div class="pdf-prev" id="uPdfPrev">
      <div class="prev-pages" id="uPrevPages"></div>
      <div class="prev-ctrl">
        <button class="btn-p" id="dlUPdf">Download</button>
        <button class="btn-s" id="closeUPdf">Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="compM">
  <div class="modal-c">
    <div class="modal-h">
      <b>Inadimpl√™ncia por Empresa</b>
      <button class="close-btn" onclick="closeModal('compM')">&times;</button>
    </div>
    <div class="sec">
      <div class="date-row">
        <div>
          <small>Data In√≠cio:</small>
          <input type="date" id="cStart">
        </div>
        <div>
          <small>Data Fim:</small>
          <input type="date" id="cEnd">
        </div>
        <button class="btn-p" id="applyC">Aplicar</button>
        <button class="btn-s" id="clearC">Limpar</button>
      </div>
    </div>
    <div class="sec" id="compCbs" style="display:none">
      <b>Empresas:</b>
      <div class="cbs" id="compList"></div>
    </div>
    <div id="cSum" style="display:none">
      <b>Resumo por Empresa</b>
      <div class="sum-cards" id="cSumCards"></div>
    </div>
    <div id="cRes">
      <div class="no-res">Selecione o per√≠odo</div>
    </div>
    <div class="btns">
      <button class="btn-pdf" id="cPdfBtn">Gerar PDF</button>
      <button class="btn-g" id="cXlsxBtn">Exportar XLSX</button>
    </div>
    <div class="pdf-prev" id="cPdfPrev">
      <div class="prev-pages" id="cPrevPages"></div>
      <div class="prev-ctrl">
        <button class="btn-p" id="dlCPdf">Download</button>
        <button class="btn-s" id="closeCPdf">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
const sample = [
  ["CLIENTE", "VENCIMENTO", "DESC", "VALOR", "LIQUIDA√á√ÉO", "VENDEDOR", "", "EMPRESA"],
  ["HOSPITAL SAM", "2025-09-01", "NF 13879", 5450, "2025-09-02", "Jo√£o", "", "Emp A"],
  ["CASA SAUDE", "2025-09-01", "NF 14499", 4200, "2025-09-08", "Maria", "", "Emp B"],
  ["INST ADV", "2025-09-01", "NF 14287", 12753, "", "Pedro", "", "Emp C"],
  ["LAB BLESS", "2025-09-15", "NF 12345", 8500, "", "Ana", "", "Emp D"],
  ["LAB BLESS", "2025-09-05", "NF 14334", 1300, "", "", "", "LABMED"]
];

let data = [];
let clients = {};
let vendors = {};
let allCli = [];
let allVend = [];
let allComp = [];

let selCli = new Set();
let selVend = new Set();
let selComp = new Set();

let dateOn = false;
let dStart = null;
let dEnd = null;

let uOn = false;
let uStart = null;
let uEnd = null;

let cOn = false;
let cStart = null;
let cEnd = null;

let pdfPages = { main: [], unpaid: [], comp: [] };

const fmt = v => isNaN(v) ? 'R$ 0,00' : new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

const fmtD = d => {
  if (!d) return '-';
  const dt = new Date(d);
  return `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}/${dt.getFullYear()}`;
};

const parseD = s => {
  if (!s) return null;
  if (s instanceof Date) return s;
  if (typeof s === 'string') {
    let d = new Date(s.split(' ')[0]);
    if (!isNaN(d)) return d;
  }
  if (typeof s === 'number') return new Date(Date.UTC(1899, 11, 30) + s * 864e5);
  return null;
};

const parseN = v => {
  if (!v) return 0;
  if (typeof v === 'number') return v;
  return parseFloat(String(v).replace(/[^\d,.\-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
};

const inRange = (d, s, e) => {
  if (!d) return false;
  const dt = new Date(d);
  if (s && e) return dt >= s && dt <= e;
  if (s) return dt >= s;
  if (e) return dt <= e;
  return true;
};

const grad = () => [
  'linear-gradient(135deg, #667eea, #764ba2)',
  'linear-gradient(135deg, #f093fb, #f5576c)',
  'linear-gradient(135deg, #11998e, #38ef7d)',
  'linear-gradient(135deg, #ee5a24, #f39c12)'
][Math.floor(Math.random() * 4)];

const showLoad = (t = 'Gerando...') => {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('loadTxt').textContent = t;
  document.getElementById('progBar').style.width = '0';
};

const hideLoad = () => document.getElementById('loading').style.display = 'none';

const setProg = p => document.getElementById('progBar').style.width = p + '%';

const toast = m => {
  const t = document.getElementById('toast');
  t.textContent = m;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2500);
};

const closeModal = id => document.getElementById(id).style.display = 'none';

// Fun√ß√£o para calcular similaridade entre strings (Levenshtein)
function similarity(s1, s2) {
  const longer = s1.length > s2.length ? s1 : s2;
  const shorter = s1.length > s2.length ? s2 : s1;
  
  if (longer.length === 0) return 1.0;
  
  // Se uma string cont√©m a outra, consideramos alta similaridade
  if (longer.toLowerCase().includes(shorter.toLowerCase())) {
    return 0.9;
  }
  
  // Implementa√ß√£o simplificada do algoritmo de Levenshtein
  const costs = [];
  for (let i = 0; i <= shorter.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= longer.length; j++) {
      if (i === 0) {
        costs[j] = j;
      } else if (j > 0) {
        let newValue = costs[j - 1];
        if (shorter.charAt(i - 1) !== longer.charAt(j - 1)) {
          newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        }
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[longer.length] = lastValue;
  }
  
  return 1 - (costs[longer.length] / Math.max(s1.length, s2.length));
}

function process() {
  clients = {};
  vendors = {};
  allCli = [];
  allVend = [];
  allComp = [];
  let n = 0;

  data.forEach(r => {
    if (!r || r.length < 4) return;
    let cl = String(r[0] || '').trim();
    if (!cl || cl.toUpperCase() === 'CLIENTE' || cl.includes('TOTAL')) return;

    const venc = r[1];
    const desc = String(r[2] || '');
    const val = parseN(r[3]);
    const liq = r[4] || '';
    const vnd = String(r[5] || '').trim() || 'N√£o Informado';
    const emp = String(r[7] || '').trim() || 'N√£o Informado';

    if (!val) return;

    if (!clients[cl]) {
      clients[cl] = { t: [], v: vnd };
      allCli.push(cl);
    }

    if (!vendors[vnd]) {
      vendors[vnd] = { t: [] };
      allVend.push(vnd);
    }

    const t = { cl, venc, desc, val, liq, emp, vnd };
    clients[cl].t.push(t);
    vendors[vnd].t.push(t);

    if (!allComp.includes(emp)) allComp.push(emp);
    n++;
  });

  allCli.sort();
  allVend.sort();
  allComp.sort();
  document.getElementById('rLoaded').textContent = n;
}

function shouldShow(t, ov, fut, pd) {
  const due = parseD(t.venc);
  const liq = parseD(t.liq);
  const isPd = liq && !isNaN(liq);

  if (dateOn) {
    if (!inRange(isPd ? liq : due, dStart, dEnd)) return false;
  }

  if (selVend.size > 0 && !selVend.has(t.vnd)) {
    return false;
  }

  if (isPd) return pd;

  if (due) {
    const td = new Date();
    td.setHours(0, 0, 0, 0);
    const dd = new Date(due);
    dd.setHours(0, 0, 0, 0);

    if (dd < td) return ov;
    if (dd > td) return fut;
    return ov || fut;
  }

  return ov;
}

function calcTot(ts) {
  let ov = 0;
  let fut = 0;
  let pd = 0;

  const cOv = document.getElementById('chkOv').checked;
  const cFut = document.getElementById('chkFut').checked;
  const cPd = document.getElementById('chkPaid').checked;

  ts.forEach(t => {
    const due = parseD(t.venc);
    const liq = parseD(t.liq);
    const isPd = liq && !isNaN(liq);

    if (isPd) {
      if (cPd) pd += t.val;
    } else if (due) {
      const td = new Date();
      td.setHours(0, 0, 0, 0);
      const dd = new Date(due);
      dd.setHours(0, 0, 0, 0);

      if (dd < td) {
        if (cOv) ov += t.val;
      } else if (dd > td) {
        if (cFut) fut += t.val;
      } else {
        if (cOv) ov += t.val;
        if (cFut) fut += t.val;
      }
    } else if (cOv) {
      ov += t.val;
    }
  });

  return { ov, fut, pd, gen: ov + fut + pd };
}

// Fun√ß√£o para calcular resumo por empresa
function calcCompanySummary(ts) {
  const byCompany = {};
  
  ts.forEach(t => {
    if (!byCompany[t.emp]) {
      byCompany[t.emp] = { 
        ov: 0, 
        fut: 0, 
        pd: 0, 
        gen: 0,
        count: 0
      };
    }
    
    const due = parseD(t.venc);
    const liq = parseD(t.liq);
    const isPd = liq && !isNaN(liq);
    
    if (isPd) {
      byCompany[t.emp].pd += t.val;
    } else if (due) {
      const td = new Date();
      td.setHours(0, 0, 0, 0);
      const dd = new Date(due);
      dd.setHours(0, 0, 0, 0);

      if (dd < td) {
        byCompany[t.emp].ov += t.val;
      } else if (dd > td) {
        byCompany[t.emp].fut += t.val;
      } else {
        byCompany[t.emp].ov += t.val;
        byCompany[t.emp].fut += t.val;
      }
    } else {
      byCompany[t.emp].ov += t.val;
    }
    
    byCompany[t.emp].count++;
    byCompany[t.emp].gen = byCompany[t.emp].ov + byCompany[t.emp].fut + byCompany[t.emp].pd;
  });
  
  return byCompany;
}

function update() {
  const ov = document.getElementById('chkOv').checked;
  const fut = document.getElementById('chkFut').checked;
  const pd = document.getElementById('chkPaid').checked;

  if (!ov && !fut && !pd) {
    document.getElementById('results').innerHTML = '<div class="no-res">Selecione pelo menos um filtro</div>';
    document.getElementById('summary').style.display = 'none';
    document.getElementById('cFound').textContent = '0';
    return;
  }

  let fc = {};

  const clientsToShow = selCli.size ? [...selCli] : Object.keys(clients);

  clientsToShow.forEach(c => {
    if (!clients[c]) return;

    const ft = clients[c].t.filter(t => shouldShow(t, ov, fut, pd));

    if (ft.length) {
      fc[c] = { t: ft, v: clients[c].v, tot: calcTot(ft) };
    }
  });

  render(fc);
}

function render(fc) {
  const res = document.getElementById('results');
  const sum = document.getElementById('summary');
  let tO = 0;
  let tF = 0;
  let tP = 0;
  let n = 0;
  let h = '<div class="cards">';

  // Calcular resumo por empresa para todos os dados
  let allFilteredTitles = [];
  Object.keys(fc).forEach(c => {
    allFilteredTitles = allFilteredTitles.concat(fc[c].t);
  });
  
  const companySummary = calcCompanySummary(allFilteredTitles);
  const hasMultipleCompanies = Object.keys(companySummary).length > 1;

  Object.keys(fc).sort().forEach(c => {
    const d = fc[c];
    const tot = d.tot;
    tO += tot.ov;
    tF += tot.fut;
    tP += tot.pd;
    n++;

    h += `<div class="card">
      <div class="card-h" style="background:${grad()}">
        ${c}<br><small>Vendedor: ${d.v}</small>
      </div>
      <div class="card-b">
        ${hasMultipleCompanies ? `
        <div class="company-summary">
          <h4>Resumo por Empresa</h4>
          <table>
            <tr>
              <th>Empresa</th>
              <th>Vencidos</th>
              <th>A Vencer</th>
              <th>Quitados</th>
              <th>Total</th>
            </tr>
            ${Object.entries(calcCompanySummary(d.t)).map(([emp, data]) => `
            <tr>
              <td>${emp}</td>
              <td>${fmt(data.ov)}</td>
              <td>${fmt(data.fut)}</td>
              <td>${fmt(data.pd)}</td>
              <td>${fmt(data.gen)}</td>
            </tr>
            `).join('')}
          </table>
        </div>
        ` : ''}
        <table>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Empresa</th>
            <th>Vencimento</th>
            <th>Valor</th>
            <th>Status</th>
          </tr>`;

    d.t.forEach(t => {
      const isPd = parseD(t.liq) && !isNaN(parseD(t.liq));
      h += `<tr>
        <td>${t.desc}</td>
        <td>${t.emp}</td>
        <td>${fmtD(parseD(t.venc))}</td>
        <td>${fmt(t.val)}</td>
        <td>${isPd ? 'Quitado' : 'Aberto'}</td>
      </tr>`;
    });

    h += `</table>
        <div class="totals">
          <div class="t-box t-ov">Vencidos<br>${fmt(tot.ov)}</div>
          <div class="t-box t-fut">A Vencer<br>${fmt(tot.fut)}</div>
          <div class="t-box t-paid">Quitados<br>${fmt(tot.pd)}</div>
          <div class="t-box t-gen">Total<br>${fmt(tot.gen)}</div>
        </div>
      </div>
    </div>`;
  });

  h += '</div>';

  if (!n) {
    res.innerHTML = '<div class="no-res">Nenhum resultado encontrado</div>';
    sum.style.display = 'none';
  } else {
    res.innerHTML = h;
    document.getElementById('tOv').textContent = fmt(tO);
    document.getElementById('tFut').textContent = fmt(tF);
    document.getElementById('tPaid').textContent = fmt(tP);
    document.getElementById('tGen').textContent = fmt(tO + tF + tP);
    sum.style.display = 'block';
  }

  document.getElementById('cFound').textContent = n;
}

function showCliCbs() {
  const searchTerm = document.getElementById('searchIn').value.toLowerCase();
  
  let filteredClients = allCli;
  
  // Se h√° termo de busca, filtrar por similaridade
  if (searchTerm.length >= 2) {
    filteredClients = allCli
      .map(c => ({ name: c, score: similarity(c.toLowerCase(), searchTerm) }))
      .filter(item => item.score > 0.3) // Limiar de similaridade
      .sort((a, b) => b.score - a.score) // Ordenar por similaridade
      .map(item => item.name);
  }
  
  document.getElementById('cliList').innerHTML = filteredClients.map(c =>
    `<label><input type="checkbox" value="${c}" ${selCli.has(c) ? 'checked' : ''}>${c}</label>`
  ).join('');

  document.getElementById('cliCbs').style.display = 'block';
  document.getElementById('dateF').style.display = 'block';

  document.getElementById('cliList').querySelectorAll('input').forEach(cb => {
    cb.onchange = function() {
      if (this.checked) {
        selCli.add(this.value);
      } else {
        selCli.delete(this.value);
      }
      update();
    };
  });
}

function showVendCbs() {
  const searchTerm = document.getElementById('vendorIn').value.toLowerCase();
  
  let filteredVendors = allVend;
  
  // Se h√° termo de busca, filtrar por similaridade
  if (searchTerm.length >= 2) {
    filteredVendors = allVend
      .map(v => ({ name: v, score: similarity(v.toLowerCase(), searchTerm) }))
      .filter(item => item.score > 0.3) // Limiar de similaridade
      .sort((a, b) => b.score - a.score) // Ordenar por similaridade
      .map(item => item.name);
  }
  
  document.getElementById('vendList').innerHTML = filteredVendors.map(v =>
    `<label><input type="checkbox" value="${v}" ${selVend.has(v) ? 'checked' : ''}>${v}</label>`
  ).join('');

  document.getElementById('vendCbs').style.display = 'block';
  document.getElementById('dateF').style.display = 'block';

  document.getElementById('vendList').querySelectorAll('input').forEach(cb => {
    cb.onchange = function() {
      if (this.checked) {
        selVend.add(this.value);
      } else {
        selVend.delete(this.value);
      }
      update();
    };
  });
}

function updateU() {
  const ur = document.getElementById('uRes');
  const us = document.getElementById('uSum');
  const usc = document.getElementById('uSumCards');

  if (!uOn) {
    ur.innerHTML = '<div class="no-res">Selecione o per√≠odo</div>';
    us.style.display = 'none';
    return;
  }

  let ut = [];
  Object.values(clients).forEach(c => {
    c.t.forEach(t => {
      const liq = parseD(t.liq);
      const due = parseD(t.venc);
      if (liq && !isNaN(liq)) return;
      if (due && inRange(due, uStart, uEnd)) ut.push(t);
    });
  });

  if (!ut.length) {
    ur.innerHTML = '<div class="no-res">Nenhuma fatura encontrada</div>';
    us.style.display = 'none';
    return;
  }

  ut.sort((a, b) => (parseD(a.venc) || 0) - (parseD(b.venc) || 0));

  const byE = {};
  ut.forEach(t => {
    if (!byE[t.emp]) byE[t.emp] = { n: 0, tot: 0 };
    byE[t.emp].n++;
    byE[t.emp].tot += t.val;
  });

  usc.innerHTML = Object.entries(byE).map(([e, d]) =>
    `<div class="sum-card"><b>${e}</b><br>Faturas: ${d.n}<br>Total: ${fmt(d.tot)}</div>`
  ).join('');
  us.style.display = 'block';

  ur.innerHTML = `<div class="tbl-wrap"><table class="u-tbl">
    <tr>
      <th>Cliente</th>
      <th>Vendedor</th>
      <th>Descri√ß√£o</th>
      <th>Empresa</th>
      <th>Vencimento</th>
      <th>Valor</th>
    </tr>
    ${ut.map(t => `<tr>
      <td>${t.cl}</td>
      <td>${t.vnd}</td>
      <td>${t.desc}</td>
      <td>${t.emp}</td>
      <td>${fmtD(parseD(t.venc))}</td>
      <td>${fmt(t.val)}</td>
    </tr>`).join('')}
  </table></div>`;
}

function updateC() {
  const cr = document.getElementById('cRes');
  const cs = document.getElementById('cSum');
  const csc = document.getElementById('cSumCards');
  const ccbs = document.getElementById('compCbs');
  const clist = document.getElementById('compList');

  if (!cOn) {
    cr.innerHTML = '<div class="no-res">Selecione o per√≠odo</div>';
    cs.style.display = 'none';
    ccbs.style.display = 'none';
    return;
  }

  let ct = [];
  Object.values(clients).forEach(c => {
    c.t.forEach(t => {
      const liq = parseD(t.liq);
      const due = parseD(t.venc);
      if (liq && !isNaN(liq)) return;
      if (due && inRange(due, cStart, cEnd)) ct.push(t);
    });
  });

  if (!ct.length) {
    cr.innerHTML = '<div class="no-res">Nenhuma fatura encontrada</div>';
    cs.style.display = 'none';
    ccbs.style.display = 'none';
    return;
  }

  const emps = [...new Set(ct.map(t => t.emp))];
  clist.innerHTML = emps.map(e =>
    `<label><input type="checkbox" value="${e}" ${selComp.has(e) ? 'checked' : ''}>${e}</label>`
  ).join('');

  ccbs.style.display = 'block';

  clist.querySelectorAll('input').forEach(cb => {
    cb.onchange = function() {
      if (this.checked) {
        selComp.add(this.value);
      } else {
        selComp.delete(this.value);
      }
      updateC();
    };
  });

  if (selComp.size) ct = ct.filter(t => selComp.has(t.emp));

  const byE = {};
  ct.forEach(t => {
    if (!byE[t.emp]) byE[t.emp] = { n: 0, tot: 0, cls: new Set() };
    byE[t.emp].n++;
    byE[t.emp].tot += t.val;
    byE[t.emp].cls.add(t.cl);
  });

  csc.innerHTML = Object.entries(byE).map(([e, d]) =>
    `<div class="sum-card"><b>${e}</b><br>Faturas: ${d.n} | Clientes: ${d.cls.size}<br>Total: ${fmt(d.tot)}</div>`
  ).join('');
  cs.style.display = 'block';

  ct.sort((a, b) => (a.emp || '').localeCompare(b.emp || ''));

  cr.innerHTML = `<div class="tbl-wrap"><table class="u-tbl">
    <tr>
      <th>Empresa</th>
      <th>Cliente</th>
      <th>Vendedor</th>
      <th>Descri√ß√£o</th>
      <th>Vencimento</th>
      <th>Valor</th>
    </tr>
    ${ct.map(t => `<tr>
      <td>${t.emp}</td>
      <td>${t.cl}</td>
      <td>${t.vnd}</td>
      <td>${t.desc}</td>
      <td>${fmtD(parseD(t.venc))}</td>
      <td>${fmt(t.val)}</td>
    </tr>`).join('')}
  </table></div>`;
}

async function genPDF(type) {
  const isLand = type !== 'main';
  const srcId = type === 'main' ? 'results' : type === 'unpaid' ? 'uRes' : 'cRes';
  const sumId = type === 'main' ? 'summary' : type === 'unpaid' ? 'uSum' : 'cSum';
  const prevId = type === 'main' ? 'prevPages' : type === 'unpaid' ? 'uPrevPages' : 'cPrevPages';
  const prevCont = type === 'main' ? 'pdfPrev' : type === 'unpaid' ? 'uPdfPrev' : 'cPdfPrev';

  showLoad('Preparando conte√∫do...');
  setProg(10);
  await new Promise(r => setTimeout(r, 100));

  const wrap = document.createElement('div');
  wrap.style.cssText = `position:absolute;left:-9999px;top:0;width:${isLand ? 1100 : 794}px;padding:20px;background:#fff;font-family:system-ui,sans-serif;`;

  const title = document.createElement('h2');
  title.textContent = type === 'main' ? 'Relat√≥rio de T√≠tulos' : type === 'unpaid' ? 'Faturas N√£o Liquidadas' : 'Inadimpl√™ncia por Empresa';
  title.style.cssText = 'text-align:center;margin-bottom:10px;';

  const dt = document.createElement('p');
  dt.textContent = 'Gerado em: ' + new Date().toLocaleString('pt-BR');
  dt.style.cssText = 'text-align:center;margin-bottom:15px;color:#666;font-size:12px;';

  wrap.appendChild(title);
  wrap.appendChild(dt);

  const sumEl = document.getElementById(sumId);
  if (sumEl && sumEl.style.display !== 'none') wrap.appendChild(sumEl.cloneNode(true));

  const resEl = document.getElementById(srcId);
  if (resEl) wrap.appendChild(resEl.cloneNode(true));

  wrap.querySelectorAll('.tbl-wrap').forEach(el => {
    el.style.maxHeight = 'none';
    el.style.overflow = 'visible';
  });

  document.body.appendChild(wrap);
  setProg(30);
  await new Promise(r => setTimeout(r, 100));

  const canvas = await html2canvas(wrap, { scale: 2, useCORS: true, logging: false });
  document.body.removeChild(wrap);
  setProg(60);

  const pageW = isLand ? 297 : 210;
  const pageH = isLand ? 210 : 297;
  const margin = 10;
  const cW = pageW - margin * 2;
  const cH = pageH - margin * 2;

  const imgW = cW;
  const imgH = (canvas.height * imgW) / canvas.width;
  const pages = [];
  let srcY = 0;
  let rem = imgH;

  while (rem > 0) {
    const sliceH = Math.min(cH, rem);
    const srcH = (sliceH / imgH) * canvas.height;

    const sliceC = document.createElement('canvas');
    sliceC.width = canvas.width;
    sliceC.height = srcH;
    sliceC.getContext('2d').drawImage(canvas, 0, srcY, canvas.width, srcH, 0, 0, canvas.width, srcH);

    pages.push({ data: sliceC.toDataURL('image/png'), h: sliceH });
    rem -= cH;
    srcY += srcH;
    setProg(60 + Math.min(30, pages.length * 5));
  }

  pdfPages[type] = pages;
  setProg(95);

  const prevEl = document.getElementById(prevId);
  prevEl.innerHTML = pages.map((p, i) =>
    `<div class="prev-page"><img src="${p.data}"><div class="pg-lbl">P√°gina ${i + 1} de ${pages.length}</div></div>`
  ).join('');

  document.getElementById(prevCont).style.display = 'block';
  hideLoad();
  toast('PDF pronto para visualiza√ß√£o!');
}

async function downloadPDF(type) {
  const pages = pdfPages[type];
  if (!pages || !pages.length) {
    toast('Gere a visualiza√ß√£o primeiro');
    return;
  }

  showLoad('Gerando PDF...');
  setProg(20);
  await new Promise(r => setTimeout(r, 100));

  const isLand = type !== 'main';
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF(isLand ? 'l' : 'p', 'mm', 'a4');

  const pageW = isLand ? 297 : 210;
  const pageH = isLand ? 210 : 297;
  const margin = 10;
  const cW = pageW - margin * 2;

  pages.forEach((p, i) => {
    if (i > 0) pdf.addPage();
    pdf.addImage(p.data, 'PNG', margin, margin, cW, p.h);
    setProg(20 + Math.floor((i + 1) / pages.length * 70));
  });

  const fn = type === 'main' ? 'relatorio_titulos' : type === 'unpaid' ? 'faturas_nao_liquidadas' : 'inadimplencia_empresa';
  pdf.save(`${fn}_${new Date().toISOString().split('T')[0]}.pdf`);
  hideLoad();
  toast('PDF baixado com sucesso!');
}

function genXLSX(type) {
  const wb = XLSX.utils.book_new();
  let rows = [];

  if (type === 'main') {
    rows = [['Cliente', 'Vendedor', 'Descri√ß√£o', 'Empresa', 'Vencimento', 'Valor', 'Status']];

    const clientsToShow = selCli.size ? [...selCli] : Object.keys(clients);

    clientsToShow.forEach(c => {
      if (!clients[c]) return;

      clients[c].t.forEach(t => {
        const ov = document.getElementById('chkOv').checked;
        const fut = document.getElementById('chkFut').checked;
        const pd = document.getElementById('chkPaid').checked;

        if (!shouldShow(t, ov, fut, pd)) return;

        const isPd = parseD(t.liq) && !isNaN(parseD(t.liq));
        rows.push([c, t.vnd, t.desc, t.emp, fmtD(parseD(t.venc)), t.val, isPd ? 'Quitado' : 'Aberto']);
      });
    });
  } else {
    rows = [['Cliente', 'Vendedor', 'Descri√ß√£o', 'Empresa', 'Vencimento', 'Valor']];

    Object.values(clients).forEach(c => {
      c.t.forEach(t => {
        const liq = parseD(t.liq);
        const due = parseD(t.venc);
        if (liq && !isNaN(liq)) return;

        const start = type === 'unpaid' ? uStart : cStart;
        const end = type === 'unpaid' ? uEnd : cEnd;

        if (!due || !inRange(due, start, end)) return;
        if (type === 'comp' && selComp.size && !selComp.has(t.emp)) return;

        rows.push([t.cl, t.vnd, t.desc, t.emp, fmtD(due), t.val]);
      });
    });
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Dados');

  const fn = type === 'main' ? 'relatorio' : type === 'unpaid' ? 'faturas_nao_liquidadas' : 'inadimplencia';
  XLSX.writeFile(wb, `${fn}_${new Date().toISOString().split('T')[0]}.xlsx`);
  toast('XLSX gerado com sucesso!');
}

document.getElementById('fileIn').onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  document.getElementById('fName').textContent = f.name;

  const r = new FileReader();
  r.onload = ev => {
    const wb = XLSX.read(ev.target.result, { type: 'binary' });
    data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
    process();
    update();
  };
  r.readAsBinaryString(f);
};

document.getElementById('clearBtn').onclick = () => {
  selCli.clear();
  selVend.clear();
  dateOn = false;
  dStart = dEnd = null;

  document.getElementById('searchIn').value = '';
  document.getElementById('vendorIn').value = '';
  document.getElementById('startD').value = '';
  document.getElementById('endD').value = '';

  ['cliCbs', 'vendCbs', 'dateF', 'pdfPrev'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });

  update();
};

document.getElementById('allCliBtn').onclick = () => {
  selCli = new Set(allCli);
  showCliCbs();
  update();
};

document.getElementById('allVendBtn').onclick = () => {
  selVend = new Set(allVend);
  showVendCbs();
  update();
};

document.getElementById('applyD').onclick = () => {
  const s = document.getElementById('startD').value;
  const e = document.getElementById('endD').value;

  if (s) {
    const [y, m, d] = s.split('-');
    dStart = new Date(y, m - 1, d);
  } else {
    dStart = null;
  }

  if (e) {
    const [y, m, d] = e.split('-');
    dEnd = new Date(y, m - 1, d, 23, 59, 59);
  } else {
    dEnd = null;
  }

  dateOn = !!(dStart || dEnd);
  update();
};

document.getElementById('clearD').onclick = () => {
  document.getElementById('startD').value = '';
  document.getElementById('endD').value = '';
  dateOn = false;
  dStart = dEnd = null;
  update();
};

['chkOv', 'chkFut', 'chkPaid'].forEach(id => {
  document.getElementById(id).onchange = update;
});

document.getElementById('pdfBtn').onclick = () => genPDF('main');
document.getElementById('dlPdf').onclick = () => downloadPDF('main');
document.getElementById('closePdf').onclick = () => document.getElementById('pdfPrev').style.display = 'none';
document.getElementById('xlsxBtn').onclick = () => genXLSX('main');

document.getElementById('unpaidBtn').onclick = () => document.getElementById('unpaidM').style.display = 'block';

document.getElementById('applyU').onclick = () => {
  const s = document.getElementById('uStart').value;
  const e = document.getElementById('uEnd').value;

  if (s) {
    const [y, m, d] = s.split('-');
    uStart = new Date(y, m - 1, d);
  } else {
    uStart = null;
  }

  if (e) {
    const [y, m, d] = e.split('-');
    uEnd = new Date(y, m - 1, d, 23, 59, 59);
  } else {
    uEnd = null;
  }

  uOn = !!(uStart || uEnd);
  updateU();
};

document.getElementById('clearU').onclick = () => {
  document.getElementById('uStart').value = '';
  document.getElementById('uEnd').value = '';
  uOn = false;
  uStart = uEnd = null;
  updateU();
};

document.getElementById('uPdfBtn').onclick = () => genPDF('unpaid');
document.getElementById('dlUPdf').onclick = () => downloadPDF('unpaid');
document.getElementById('closeUPdf').onclick = () => document.getElementById('uPdfPrev').style.display = 'none';
document.getElementById('uXlsxBtn').onclick = () => genXLSX('unpaid');

document.getElementById('compUnpaidBtn').onclick = () => document.getElementById('compM').style.display = 'block';

document.getElementById('applyC').onclick = () => {
  const s = document.getElementById('cStart').value;
  const e = document.getElementById('cEnd').value;

  if (s) {
    const [y, m, d] = s.split('-');
    cStart = new Date(y, m - 1, d);
  } else {
    cStart = null;
  }

  if (e) {
    const [y, m, d] = e.split('-');
    cEnd = new Date(y, m - 1, d, 23, 59, 59);
  } else {
    cEnd = null;
  }

  cOn = !!(cStart || cEnd);
  selComp.clear();
  updateC();
};

document.getElementById('clearC').onclick = () => {
  document.getElementById('cStart').value = '';
  document.getElementById('cEnd').value = '';
  cOn = false;
  cStart = cEnd = null;
  selComp.clear();
  updateC();
};

document.getElementById('cPdfBtn').onclick = () => genPDF('comp');
document.getElementById('dlCPdf').onclick = () => downloadPDF('comp');
document.getElementById('closeCPdf').onclick = () => document.getElementById('cPdfPrev').style.display = 'none';
document.getElementById('cXlsxBtn').onclick = () => genXLSX('comp');

document.querySelectorAll('.modal').forEach(m => {
  m.onclick = e => {
    if (e.target === m) m.style.display = 'none';
  };
});

document.getElementById('searchIn').oninput = function() {
  const q = this.value.toLowerCase();
  if (q.length < 2) {
    selCli.clear();
    document.getElementById('cliCbs').style.display = 'none';
    update();
    return;
  }

  // Filtrar clientes por similaridade
  const filteredClients = allCli
    .map(c => ({ name: c, score: similarity(c.toLowerCase(), q) }))
    .filter(item => item.score > 0.3)
    .sort((a, b) => b.score - a.score)
    .map(item => item.name);
  
  selCli = new Set(filteredClients);
  showCliCbs();
  update();
};

document.getElementById('vendorIn').oninput = function() {
  const q = this.value.toLowerCase();
  if (q.length < 2) {
    selVend.clear();
    document.getElementById('vendCbs').style.display = 'none';
    update();
    return;
  }

  // Filtrar vendedores por similaridade
  const filteredVendors = allVend
    .map(v => ({ name: v, score: similarity(v.toLowerCase(), q) }))
    .filter(item => item.score > 0.3)
    .sort((a, b) => b.score - a.score)
    .map(item => item.name);
  
  selVend = new Set(filteredVendors);
  showVendCbs();
  update();
};

data = sample;
process();
update();
</script>
</body>
</html>